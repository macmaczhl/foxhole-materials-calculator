name: "Dependabot Auto-Merge (non-major)"

on:
  pull_request_target:
    types: [opened, reopened, labeled, synchronize]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  enable-auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' || startsWith(github.actor, 'dependabot-preview')
    steps:
      - name: Check and enable auto-merge for Dependabot PRs
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            // fetch PR metadata
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });

            // Security check: verify PR comes from same repository (not a fork)
            // Also handles case where head repo has been deleted (pr.data.head.repo is null)
            if (!pr.data.head.repo || pr.data.head.repo.full_name !== pr.data.base.repo.full_name) {
              core.info('PR is from a fork or head repo deleted; skipping auto-merge for security');
              return;
            }

            const labels = pr.data.labels.map(l => l.name);
            if (!labels.includes('automerge')) {
              core.info('No automerge label; skipping');
              return;
            }

            // Check for major version update in PR title
            // Dependabot titles follow pattern: "Bump <package> from <old_version> to <new_version>"
            const title = pr.data.title;
            const versionMatch = title.match(/from\s+(\d+)(?:\.\d+)*(?:-[\w.]+)?(?:\+[\w.]+)?\s+to\s+(\d+)(?:\.\d+)*(?:-[\w.]+)?(?:\+[\w.]+)?/i);
            if (versionMatch) {
              const oldMajor = parseInt(versionMatch[1], 10);
              const newMajor = parseInt(versionMatch[2], 10);
              if (!isNaN(oldMajor) && !isNaN(newMajor) && newMajor > oldMajor) {
                await github.rest.issues.createComment({ 
                  owner, 
                  repo, 
                  issue_number: prNumber, 
                  body: `⚠️ This is a **major version update** (${oldMajor}.x.x → ${newMajor}.x.x). Auto-merge is disabled for major updates. Please review the changelog and merge manually.` 
                });
                core.info('Major version update detected; skipping auto-merge');
                return;
              }
            }

            // list changed files (no checkout) and detect CI/workflow changes
            const files = [];
            for await (const resp of github.paginate.iterator(github.rest.pulls.listFiles, { owner, repo, pull_number: prNumber })) {
              resp.data.forEach(f => files.push(f.filename));
            }
            const ciPatterns = [
              '^\\.github\\/workflows\\/',
              '^\\.github\\/dependabot.yml$',
              '^\\.github\\/CODEOWNERS$',
              '^\\.circleci\\/',
              '^Dockerfile$',
              '^\\.github\\/actions\\/',
              '^jest\\.config\\.(js|ts|mjs|cjs)$',
              '^eslint\\.config\\.(js|ts|mjs|cjs)$'
            ];
            const ciRegexes = ciPatterns.map(p => new RegExp(p));
            if (files.some(f => ciRegexes.some(r => r.test(f)))) {
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: 'CI/workflow/config files were changed in this PR — skipping auto-merge and leaving for manual review.' });
              core.info('CI files changed; skipping auto-merge');
              return;
            }

            // Check if auto-merge is already enabled
            if (pr.data.auto_merge) {
              core.info('Auto-merge is already enabled; skipping');
              return;
            }

            // enable GitHub auto-merge (merge method: MERGE)
            try {
              await github.graphql(
                `mutation ($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod:  SQUASH }) {
                    pullRequest { number }
                  }
                }`,
                { pullRequestId: pr.data.node_id }
              );
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: 'Auto-merge enabled for this Dependabot PR (non-major). It will merge when checks pass and required approvals are present.' });
              core.info('Auto-merge enabled');
            } catch (err) {
              core.warning('Failed to enable auto-merge: ' + err.message);
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: 'Auto-merge enable failed; you can merge manually when checks pass.' });

            }

