name: Dependabot Auto-Merge

on:
  workflow_run:
    workflows: ["Lint and Test"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge Dependabot PR
    runs-on: ubuntu-latest
    # Only run if the triggering workflow was successful
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Get PR number
        id: get-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });
            
            if (pulls.data.length === 0) {
              core.info('No open PR found for this branch');
              return;
            }
            
            // Find the PR from Dependabot specifically
            const dependabotPR = pulls.data.find(pr => pr.user.login === 'dependabot[bot]');
            
            if (!dependabotPR) {
              core.info('No Dependabot PR found for this branch');
              return;
            }
            
            // Use GITHUB_OUTPUT instead of deprecated setOutput
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `pr_number=${dependabotPR.number}\n`);

      - name: Merge PR
        if: steps.get-pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumberStr = '${{ steps.get-pr.outputs.pr_number }}';
            const prNumber = parseInt(prNumberStr);
            
            // Validate the PR number
            if (!prNumber || isNaN(prNumber)) {
              core.setFailed('Invalid PR number');
              return;
            }
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              core.info(`Successfully merged PR #${prNumber}`);
            } catch (error) {
              core.setFailed(`Failed to merge PR: ${error.message}`);
            }
